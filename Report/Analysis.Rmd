---
title: "Analysis"
author: "Nina"
date: "05/05/2022"
output: html_document
---

```{r, echo = FALSE, message = FALSE}
source(here::here("Scripts/SetUp.R"))
```
## Splitting the data into Traning set and Test set 

```{r}
set.seed(123) ## for replication purpose
## the index of the rows that will be in the training set
index.tr <- sample(1:nrow(bands3_reduced), replace=FALSE,
                   size=0.75*nrow(bands3_reduced))
bands3_reduced.tr <- bands3_reduced[index.tr,] ## the training set
bands3_reduced.te <- bands3_reduced[-index.tr,] ## the test set
```

## Balancing the Training set : PAS BESOIN POUR L'INSTANT

```{r}
#band1 <- min(table(bands3_reduced.tr$band_type)) ## 171
## the "band" cases
#data.tr.band1 <- filter(bands3_reduced.tr, band_type=="band")
## the "noband" cases
#data.tr.band2 <- filter(bands3_reduced.tr, band_type=="noband")

## sub-sample 171 instances from the number of "noband" cases
#index.band2 <- sample(size=band1, 
#                           x=1:nrow(data.tr.band2), 
#                           replace=FALSE)

  
## Bind all the "Central Andes" and the sub-sampled "Central Pyrenees" 
## and the sub-sampled "Sierra de Guadarrama"
#bands3_reduced.tr <- data.frame(rbind(data.tr.band1,
#                                     data.tr.band2[index.band2,])) 
## The cases are now balanced
#table(bands3_reduced.tr$band_type)
```

## Boruta algo 

```{r}
#we treat the missing values 
bands3_reduced <- bands3_reduced[complete.cases(bands3_reduced),]

#convert categoric into factor
#quali <- c(29,1:11)
convert <- c(29, 1:11)
#bands3_reduced[,convert] <- data.frame(apply(bands3_reduced[convert], 2, #as.factor))  --> marche pas donc 1 par 1 

bands3_reduced$grain_screened <- as.factor(bands3_reduced$grain_screened)
bands3_reduced$proof_ink <- as.factor(bands3_reduced$proof_ink)
bands3_reduced$paper_type <- as.factor(bands3_reduced$paper_type)
bands3_reduced$ink_type <- as.factor(bands3_reduced$ink_type)
bands3_reduced$solvent_type <- as.factor(bands3_reduced$solvent_type)
bands3_reduced$cylinder_type <- as.factor(bands3_reduced$cylinder_type)
bands3_reduced$press_type <- as.factor(bands3_reduced$press_type)
bands3_reduced$press <- as.factor(bands3_reduced$press)
bands3_reduced$cylinder_size <- as.factor(bands3_reduced$cylinder_size)
bands3_reduced$location <- as.factor(bands3_reduced$location)
bands3_reduced$plating_tank <- as.factor(bands3_reduced$plating_tank)
bands3_reduced$band_type <- as.factor(bands3_reduced$band_type)


library(Boruta)
library(targets)
# Decide if a variable is important or not using Boruta
set.seed(123)
boruta_output <- Boruta(band_type ~ . , data=bands3_reduced, doTrace=2) # perform Boruta search

plot(boruta_output, xlab = "", xaxt = "n")
lz<-lapply(1:ncol(boruta_output$ImpHistory),function(i)
boruta_output$ImpHistory[is.finite(boruta_output$ImpHistory[,i]),i])
names(lz) <- colnames(boruta_output$ImpHistory)
Labels <- sort(sapply(lz,median))
axis(side = 1,las=2,labels = names(Labels),
at = 1:ncol(boruta_output$ImpHistory), cex.axis = 0.7)

```
## Random forest

```{r}

bands3_reduced.tr$grain_screened <- as.factor(bands3_reduced.tr$grain_screened)
bands3_reduced.tr$proof_ink <- as.factor(bands3_reduced.tr$proof_ink)
bands3_reduced.tr$paper_type <- as.factor(bands3_reduced.tr$paper_type)
bands3_reduced.tr$ink_type <- as.factor(bands3_reduced.tr$ink_type)
bands3_reduced.tr$solvent_type <- as.factor(bands3_reduced.tr$solvent_type)
bands3_reduced.tr$cylinder_type <- as.factor(bands3_reduced.tr$cylinder_type)
bands3_reduced.tr$press_type <- as.factor(bands3_reduced.tr$press_type)
bands3_reduced.tr$press <- as.factor(bands3_reduced.tr$press)
bands3_reduced.tr$cylinder_size <- as.factor(bands3_reduced.tr$cylinder_size)
bands3_reduced.tr$location <- as.factor(bands3_reduced.tr$location)
bands3_reduced.tr$plating_tank <- as.factor(bands3_reduced.tr$plating_tank)
bands3_reduced.tr$band_type <- as.factor(bands3_reduced.tr$band_type)

bands3_reduced.te$grain_screened <- as.factor(bands3_reduced.te$grain_screened)
bands3_reduced.te$proof_ink <- as.factor(bands3_reduced.te$proof_ink)
bands3_reduced.te$paper_type <- as.factor(bands3_reduced.te$paper_type)
bands3_reduced.te$ink_type <- as.factor(bands3_reduced.te$ink_type)
bands3_reduced.te$solvent_type <- as.factor(bands3_reduced.te$solvent_type)
bands3_reduced.te$cylinder_type <- as.factor(bands3_reduced.te$cylinder_type)
bands3_reduced.te$press_type <- as.factor(bands3_reduced.te$press_type)
bands3_reduced.te$press <- as.factor(bands3_reduced.te$press)
bands3_reduced.te$cylinder_size <- as.factor(bands3_reduced.te$cylinder_size)
bands3_reduced.te$location <- as.factor(bands3_reduced.te$location)
bands3_reduced.te$plating_tank <- as.factor(bands3_reduced.te$plating_tank)
bands3_reduced.te$band_type <- as.factor(bands3_reduced.te$band_type)

#band_type = as.factor(bands3_reduced$band_type)
#bands3_reduced$band_type.new = band_type

#band_type = as.factor(bands3_reduced.te$band_type)
#bands3_reduced.te$band_type.new = band_type


rf <- randomForest( band_type ~ .,data=bands3_reduced, importance = TRUE)
pred = predict(rf, newdata=bands3_reduced)
               

predtr <- predict(rf, newdata = bands3_reduced.tr)
predte <-  predict(rf, newdata=bands3_reduced.te)
cmtr <-   table(bands3_reduced.tr, predtr)      #impossible d’utiliser xtfrm sur un tableau de données (data frame)

cmte <-  table(bands3_reduced.te, predte) #impossible d’utiliser xtfrm sur un tableau de données (data frame)
> 
varImpPlot(rf, cex = 0.65)
importance(rf)
Acc_tr <- sum(diag(cmtr))/sum(cmtr)
Acc_te <- sum(diag(cmte))/sum(cmte)


cm
Acc
```
## Relative Importance Method (MARCHE PAS) 
```{r}

library(relaimpo)

regressor <- lm(band_type ~ . , data = bands3_reduced) 
#fit lm() model

relImportance <- calc.relimp(regressor, type = "lmg", rela = TRUE) 

#calculate relative importance scaled to 100

sort(relImportance$lmg, decreasing=TRUE) # relative importance
```
## CART model 

```{r}
library(rpart)
set.seed(123456)
bands <- rpart(band_type ~ ., method = "class", data = bands3_reduced.tr, control = rpart.control(minsplit = 4,
    cp = 1e-05), model = TRUE)
summary(bands)
```

```{r}
par(pty = "s", mar = c(1, 1, 1, 1))
plot(bands, cex = 1)
text(bands, cex = 0.6)
```



## Naïve Bayes

Conditional density Plots with 'usekernel=TRUE' 
```{r}
model.nb <- naive_bayes(band_type ~ .,
                       data = bands3_reduced.tr %>%
  select(!c(proof_ink, grain_screened, paper_type, ink_type, solvent_type, cylinder_type, press_type, press)), usekernel=TRUE, laplace=1)
#par(mfrow=c(2,2))
plot(model.nb, arg.num = list(col = 1:3,
                             legend.position = "topright",
                             legend.cex = 0.8),
     prob="conditional")
par(mfrow=c(1,1))
model.nb
```


Conditional density plots with 'uskernel=FALSE'. It means that Gaussian distribution is applied to 'numeric' vairable. 
```{r}
model.nb2 <- naive_bayes(band_type ~ .,
                       data = bands3_reduced.tr%>%
  select(!c(proof_ink, grain_screened, paper_type, ink_type, solvent_type, cylinder_type, press_type, press)), usekernel=FALSE, laplace=1) 
#par(mfrow=c(2,2))
plot(model.nb2, arg.num = list(col = 1:3,
                             legend.position = "topright",
                             legend.cex = 0.8), prob="conditional")
par(mfrow=c(1,1))
model.nb2
```

# Confusion matrix train data set 
```{r}
p1 <- predict(model.nb, bands3_reduced.tr[-c(1:9)])
(tab1 <- table(p1, bands3_reduced.tr$band_type))
sum(diag(tab1)) / sum(tab1)
```
# Confusion Matrix test data set 
```{r}
p2 <- predict(model.nb, bands3_reduced.te[-c(1:9)])
(tab2 <- table(p2, bands3_reduced.te$band_type))
sum(diag(tab2)) / sum(tab2)
```


## K-NN Model (marche pas)

We use a 2-NN to predict the test set using the training set
```{R}
library(caret)
set.seed(123)
KNN <- knn3(data=bands3_reduced,bands3_reduced.tr$band_type ~ ., k=2)
MR.te.pred <- predict(KNN, newdata = bands3_reduced,type ="class") 
TAB <- table(Obs=bands3_reduced.tr$band_type, Pred= BR.te.pred) # confusion matrix 
TAB
(ACC <- sum(diag(TAB))/sum(TAB)) # accuracy 
```

