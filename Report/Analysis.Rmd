---
title: "Analysis"
author: "Nina"
date: "05/05/2022"
output: html_document
---

```{r, echo = FALSE, message = FALSE}
source(here::here("Scripts/SetUp.R"))
```


### Replace the NAs by the mean of the closest observations
Some of the models we will use do not work with NAs. To deal with them, we decided to replace the NAs by the median of their variables. 

```{r}

#Discrete variables 

bands3_reduced2 <- bands3_reduced2 %>%
     mutate(proof_cut=replace_na(proof_cut, median(proof_cut, na.rm=TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(viscosity=replace_na(viscosity,median(viscosity, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2%>%
  mutate(ink_temperature=replace_na(ink_temperature,median(ink_temperature, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(humidity=replace_na(humidity,median(humidity, na.rm = TRUE)))
#bands3_reduced <- bands3_reduced %>%
  #mutate(blade_pressure=replace_na(blade_pressure,median(blade_pressure, na.rm = TRUE)))
#bands3_reduced <- bands3_reduced %>%
  #mutate(press_speed=replace_na(press_speed,median(press_speed, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(roller_durometer=replace_na(roller_durometer,mean(roller_durometer, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(current_density=replace_na(current_density,median(current_density, na.rm = TRUE)))
bands3_reduced2 <-bands3_reduced2 %>%
  mutate(anode_space_ratio=replace_na(anode_space_ratio,median(anode_space_ratio, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(chrome_content=replace_na(chrome_content,median(chrome_content, na.rm = TRUE)))

#Continous
#bands3_reduced2 <- bands3_reduced2 %>%
  #mutate(caliper=replace_na(caliper,median(caliper, na.rm = TRUE)))
#bands3_reduced2 <- bands3_reduced2 %>%
  #mutate(roughness=replace_na(roughness,median(roughness, na.rm = TRUE)))
#bands3_reduced2 <- bands3_reduced2 %>%
  #mutate(varnish_pct=replace_na(varnish_pct,median(varnish_pct, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(ink_pct=replace_na(ink_pct,median(ink_pct, na.rm = TRUE)))
bands3_reduced <- bands3_reduced %>%
  mutate(wax=replace_na(wax,median(wax, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(hardener=replace_na(hardener,median(hardener, na.rm = TRUE)))
bands3_reduced2 <- bands3_reduced2 %>%
  mutate(solvent_pct=replace_na(solvent_pct,median(solvent_pct, na.rm = TRUE)))


```
## Splitting the data into Traning set and Test set 

```{r}
bands3_reduced2 <- na.omit(bands3_reduced2)
set.seed(123) ## for replication purpose
## the index of the rows that will be in the training set
index.tr <- sample(1:nrow(bands3_reduced2), replace=FALSE,
                   size=0.75*nrow(bands3_reduced2))
bands3_reduced2.tr <- bands3_reduced2[index.tr,] ## the training set
bands3_reduced2.te <- bands3_reduced2[-index.tr,] ## the test set
```

## Balancing the Training set : PAS BESOIN POUR L'INSTANT

```{r}
#band1 <- min(table(bands3_reduced.tr$band_type)) ## 171
## the "band" cases
#data.tr.band1 <- filter(bands3_reduced.tr, band_type=="band")
## the "noband" cases
#data.tr.band2 <- filter(bands3_reduced.tr, band_type=="noband")

## sub-sample 171 instances from the number of "noband" cases
#index.band2 <- sample(size=band1, 
#                           x=1:nrow(data.tr.band2), 
#                           replace=FALSE)

  
## Bind all the "Central Andes" and the sub-sampled "Central Pyrenees" 
## and the sub-sampled "Sierra de Guadarrama"
#bands3_reduced.tr <- data.frame(rbind(data.tr.band1,
#                                     data.tr.band2[index.band2,])) 
## The cases are now balanced
#table(bands3_reduced.tr$band_type)
```



## Random forest

```{r}

bands3_reduced2.tr$grain_screened <- as.factor(bands3_reduced2.tr$grain_screened)
bands3_reduced2.tr$paper_type <- as.factor(bands3_reduced2.tr$paper_type)
bands3_reduced2.tr$ink_type <- as.factor(bands3_reduced2.tr$ink_type)
bands3_reduced2.tr$cylinder_type <- as.factor(bands3_reduced2.tr$cylinder_type)
bands3_reduced2.tr$press_type <- as.factor(bands3_reduced2.tr$press_type)
bands3_reduced2.tr$press <- as.factor(bands3_reduced2.tr$press)
bands3_reduced2.tr$cylinder_size <- as.factor(bands3_reduced2.tr$cylinder_size)
bands3_reduced2.tr$band_type <- as.factor(bands3_reduced2.tr$band_type)

bands3_reduced2.te$grain_screened <- as.factor(bands3_reduced2.te$grain_screened)
bands3_reduced2.te$paper_type <- as.factor(bands3_reduced2.te$paper_type)
bands3_reduced2.te$ink_type <- as.factor(bands3_reduced2.te$ink_type)
bands3_reduced2.te$cylinder_type <- as.factor(bands3_reduced2.te$cylinder_type)
bands3_reduced2.te$press_type <- as.factor(bands3_reduced2.te$press_type)
bands3_reduced2.te$press <- as.factor(bands3_reduced2.te$press)
bands3_reduced2.te$cylinder_size <- as.factor(bands3_reduced2.te$cylinder_size)
bands3_reduced2.te$band_type <- as.factor(bands3_reduced2.te$band_type)


rf <- randomForest(band_type ~ .,data=bands3_reduced2, importance = TRUE)
pred = predict(rf, newdata=bands3_reduced2)
               
               

predtr <- predict(rf, newdata = bands3_reduced.tr)
predte <-  predict(rf, newdata=bands3_reduced.te)
cmtr <-   table(bands3_reduced.tr, predtr)      #impossible d’utiliser xtfrm sur un tableau de données (data frame)

cmte <-  table(bands3_reduced.te, predte) #impossible d’utiliser xtfrm sur un tableau de données (data frame)
> 
varImpPlot(rf, cex = 0.65)
importance(rf)
Acc_tr <- sum(diag(cmtr))/sum(cmtr)
Acc_te <- sum(diag(cmte))/sum(cmte)


cm
Acc
```

## CART model 

```{r}
library(rpart)
set.seed(123456)
bands <- rpart(band_type ~ ., method = "class", data = bands3_reduced.tr, control = rpart.control(minsplit = 4,
    cp = 1e-05), model = TRUE)
summary(bands)
```

```{r}
par(pty = "s", mar = c(1, 1, 1, 1))
plot(bands, cex = 1)
text(bands, cex = 0.6)
```



## Naïve Bayes

Conditional density Plots with 'usekernel=TRUE' 
```{r}
model.nb <- naive_bayes(band_type ~ .,
                       data = bands3_reduced.tr, usekernel=TRUE, laplace=1)
#par(mfrow=c(2,2))
plot(model.nb, arg.num = list(col = 1:3,
                             legend.position = "topright",
                             legend.cex = 0.8),
     prob="conditional")
par(mfrow=c(1,1))
model.nb
```


Conditional density plots with 'uskernel=FALSE'. It means that Gaussian distribution is applied to 'numeric' vairable. 
```{r}
model.nb2 <- naive_bayes(band_type ~ .,
                       data = bands3_reduced.tr, usekernel=FALSE, laplace=1) 
#par(mfrow=c(2,2))
plot(model.nb2, arg.num = list(col = 1:3,
                             legend.position = "topright",
                             legend.cex = 0.8), prob="conditional")
par(mfrow=c(1,1))
model.nb2
```

# Confusion matrix train data set 
```{r}
p1 <- predict(model.nb, bands3_reduced.tr[quanti])
(tab1 <- table(p1, bands3_reduced.tr$band_type))
sum(diag(tab1)) / sum(tab1)
```
The accuracy for the train data set is 75,2381 %.

# Confusion Matrix test data set 
```{r}
p2 <- predict(model.nb, bands3_reduced.te[quanti])
(tab2 <- table(p2, bands3_reduced.te$band_type))
sum(diag(tab2)) / sum(tab2)
```
The accuracy for the train data set is 66,19718 %.


## K-NN Model

We use a 2-NN to predict the test set using the training set
```{R}
library(caret)
set.seed(123)
KNN <- knn3(data=bands3_reduced.tr, band_type ~ ., k=2)
MR.te.pred <- predict(KNN, newdata = bands3_reduced.tr,type ="class") 
TAB <- table(Obs=bands3_reduced.tr$band_type, Pred= BR.te.pred) # confusion matrix 
TAB
(ACC <- sum(diag(TAB))/sum(TAB)) # accuracy 
```
The accuracy is aroud 86,666%.


## Neural Network 

```{r cache = TRUE, message = FALSE, warning = FALSE, results = 'hide'}
set.seed(1)
fitControl <- trainControl(method = "cv", 
                           number = 10)
nnetGrid <-  expand.grid(size = seq(from = 1, to = 6, by = 1),
                        decay = seq(from = 0.1, to = 0.5, by = 0.1))
nnetFit <- train(band_type ~ ., 
                 data = bands3_reduced.tr,
                 method = "nnet",
                 metric = "Accuracy",
                 tuneGrid = nnetGrid,
                 trControl = fitControl)
```

```{r}
plot(nnetFit)
```

The best Neural Networks parameters would be to choose 6 hidden layers, with a decay of 0.1. 

The manually written Neural Network model 
```{r}
set.seed(345)
nn4 <- nnet(band_type ~ ., data=bands3_reduced.tr, size=6, decay = 0.1)
nn4_pred <- predict(nn4, type="class")
tab4 <- table(Obs=bands3_reduced.tr$band_type, Pred=nn4_pred) # confusion matrix
tab4
(acc4 <- sum(diag(tab4))/sum(tab4)) # accuracy
```

Here it says that the accuracy is 82,86%.

```{r}
# Confusion Matrix
confusionMatrix(data=as.factor(nn4_pred), reference = bands3_reduced.tr$band_type)
```
